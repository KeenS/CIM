#!/bin/sh -
if [ -z "$LISP_IMPL" ];then
    . "$CIM_HOME/config/current.$CIM_ID"
    export LISP_IMPL
else
    . "$CIM_HOME/scripts/cim_utils"
    LISP_IMPL=`cim_normarize_impl_version "$LISP_IMPL"`
fi

if expr "$LISP_IMPL" : 'sbcl.*' > /dev/null 2>&1 ;then
    [ -z "$CIM_UTILS" ] &&  . "$CIM_HOME/scripts/cim_utils"
    cim_set_sbcl_home_for "$LISP_IMPL"
    export SBCL_HOME
fi

if tput=`which tput 2> /dev/null` 2>&1;then
    COLUMNS=`$tput cols`
    export COLUMNS
fi

for ARG;do
    case "$ARG" in
	--repl) use_repl=true ;;
	--no-rl) no_rl=true ;;
	--debug) debug=true;;
	--core)
	    lisp_core_file=$2
	    shift 2
	    ;;
	-*)
	    OPTIND=1
	    while getopts :rd OPT "$ARG"; do
		case "$OPT" in
		    d) debug=true;;
		    r) use_repl=true;;
		esac
	    done
	    ;;
	    
    esac
done

load_file="$CIM_HOME/lib/script.lisp"
if [ "$use_repl" = true ] && [ ! "$no_rl" = true ] && rlwrap=`which rlwrap 2> /dev/null`;then
    rlwrap="$rlwrap -c -H $HOME/.lisp_history -i -q \" -r "
fi

run_lisp(){
    exec $rlwrap "$CIM_HOME/bin/$LISP_IMPL" "$@"
}

case "$LISP_IMPL" in
    sbcl*)
        if [ -s "$lisp_core_file" ]; then
            run_lisp --core "$lisp_core_file" --noinform --no-sysinit --no-userinit --non-interactive --load "$load_file" -- "$@"
        else
            run_lisp --noinform --no-sysinit --no-userinit --non-interactive --load "$load_file" -- "$@"
        fi
        ;;
    clisp*)
        if [ -s "$lisp_core_file" ]; then
            run_lisp -M "$lisp_core_file" -norc --quiet --silent -on-error exit -i "$load_file" -- "$@"
        else
            run_lisp -norc --quiet --silent -on-error exit -i "$load_file" -- "$@"
        fi
        ;;
    ecl*)
        run_lisp -norc -q -shell "$load_file" -- "$@"
        ;;
    ccl*)
        if [ -s "$lisp_core_file" ]; then
            run_lisp -I "$lisp_core_file" --no-init --quiet --batch --load "$load_file" -- "$@"
        else
            run_lisp --no-init --quiet --batch --load "$load_file" -- "$@"
        fi
        ;;
    gcl*)
        run_lisp -batch -load "$load_file" -- "$@"
        ;;
    abcl*)
        run_lisp --noinform --noinit --nosystem --batch --load "$load_file" -- "$@"
        ;;
    alisp*)
        if [ -s "$lisp_core_file" ]; then
            run_lisp -I "$lisp_core_file" --qq -L "$load_file" --kill -- "$@"
        else
            run_lisp --qq -L "$load_file" --kill -- "$@"
        fi
        ;;
    "")
        echo "\$LISP_IMPL is not set. Have you initialized cim?" >&2
        exit 1
        ;;
    *)
        echo "Unknown lisp implementation $LISP_IMPL. Exit." >&2
        exit 1
        ;;
esac
