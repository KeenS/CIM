#!/bin/sh -
# This file is for execute
. "$CIM_HOME/config/current"
case "$LISP_IMPL" in
    sbcl)
	cl_command="$CIM_HOME/bin/sbcl --noinform --no-userinit --no-sysinit"
	cl_batch="--disable-debugger"
	cl_eval="--eval"
	cl_load="--load"
	cl_quit='--quit'
	;;
    clisp)
	cl_command="$CIM_HOME/bin/clisp -norc --quiet --silent"
	cl_batch=""
	cl_eval="-x"
	cl_load="-i"
	cl_quit="$cl_eval '(quit)'"
	;;
    ecl)
	cl_command="$CIM_HOME/bin/ecl -norc"
	cl_batch=""
	cl_eval="-eval"
	cl_load="-load"
	cl_quit="$cl_eval '(quit)'"
	;;
    ccl)
	cl_command="$CIM_HOME/bin/ccl --no-init --quiet"
	cl_batch="--batch"
	cl_eval="--eval"
	cl_load="--load"
	cl_quit="$cl_eval '(quit)'"
	;;
    gcl)
	cl_command="$CIM_HOME/bin/gcl"
	cl_batch="-batch"
	cl_eval="-eval"
	cl_load="-f"
	cl_quit="$cl_eval '(quit)'"
	;;
    abcl)
	cl_command="java -jar $CIM_HOME/bin/abcl.jar --noinform --noinit --nosystem"
	cl_batch="--batch"
	cl_eval="--eval"
	cl_load="--load"
	cl_quit="$cl_eval '(quit)'"
	;;
    "")
	echo "\$LISP_IMPL is not set. Have you loaded ~/.cim/scripts/cim ?" >&2
	exit 1
	;;
    *)
	echo "Unknown lisp implementation $LISP_IMPL. Exit." >&2
	exit 1
	;;
esac

cl_debug="$cl_batch"
while getopts ":adhe:FlnpL:Sv" frag;do
    case "$frag" in
	a) cl_autosplit=true;;
	d) cl_debug="";;
	h) cl_print_help; exit 0;;
	e) cl_sexp="$cl_sexp $OPTARG";;
	F) cl_IFS="$OPTARG";;
	l) cl_lineend=true;;
	n) cl_eachline=true;;
	p) cl_printline=true;;
	L) cl_load_systems="$OPTARG";;
	S) cl_script_path=true;;
	v) cl_print_version; exit 0;;
    esac
done
shift $(( $OPTIND - 1 ))

cl_init_file="$HOME/.lisprc"
if [ -n "$cl_sexp" ]; then
    echo "$cl_sexps"
    $cl_command "$cl_debug" "$cl_load" "$cl_init_file" "$cl_eval" "(progn $cl_sexp )" $cl_quit
elif [ -n "$cl_file" ]; then
    $cl_command "$cl_debug" "$cl_load" "$cl_init_file" "$cl_load" "$file" $cl_quit
else
    $cl_command "$cl_load" "$cl_init_file" "$cl_eval" "(setf *args* (quote ($*)))" "$cl_load" "$HOME/.cim/lib/repl.lisp" "$cl_eval" '(repl)'  $cl_quit
fi
