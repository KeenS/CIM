#!/bin/sh -
# This file is for execute
. "$CIM_HOME/config/current"
cim_ext_file="$CIM_HOME/lib/cim-ext.lisp"
cl_init_file="$HOME/.lisprc"
lib_repl="$CIM_HOME/lib/repl.lisp"
if rlwrap=`which rlwrap`;then
    rlwrap="$rlwrap -c -H $HOME/.lisp_history -i -m -q \" -r "
fi
while getopts ":adhe:FlnpL:SvQ" frag;do
    case "$frag" in
	a) cl_autosplit=true;;
	d) cl_debug=true;;
	h) cl_print_help; exit 0;;
	e) cl_sexp="$cl_sexp $OPTARG";cl_sexp_p=true;;
	F) cl_IFS="$OPTARG";;
	l) cl_lineend=true;;
	n) cl_eachline=true;;
	p) cl_printline=true;;
	L) cl_sexp="$cl_sexp (load \"$OPTARG\")";;
	S) cl_script_path=true;;
	v) cl_print_version; exit 0;;
	Q) cl_init_file="$CIM_HOME/res/noinit";;
    esac
done
cl_sexp="(progn $cl_sexp (values))"
shift $(( $OPTIND - 1 ))
if [ -z "$cl_sexp_p" ] && [ -f "$1" ]; then
    cl_file="$1"
    shift
fi
case "$lisp_impl" in
    sbcl)
	if [ -n "$cl_sexp_p" ]; then
	    exec "$CIM_HOME/bin/sbcl" --noinform --no-sysinit --non-interactive --userinit "$cim_ext_file" --load "$cl_init_file" --eval "$cl_sexp" -- "$@"
	elif [ -n "$cl_file" ]; then
	    exec "$CIM_HOME/bin/sbcl" --noinform --no-sysinit --no-userinit --userinit  "$cim_ext_file" --load "$cl_init_file" --script "$cl_file" -- "$@"
	else
	    exec $rlwrap "$CIM_HOME/bin/sbcl" --noinform --no-sysinit --load "$cim_ext_file" --load "$cl_init_file" --script "$lib_repl" -- "$@"
	fi
	;;
    clisp)
	if [ -n "$cl_sexp_p" ]; then
	    exec "$CIM_HOME/bin/clisp" -norc --quiet --silent -on-error exit -i "$cim_ext_file" -i "$cl_init_file" -x "$cl_sexp" -- "$@"
	elif [ -n "$cl_file" ]; then
	    exec "$CIM_HOME/bin/clisp" -norc --quiet --silent -on-error exit -i "$cim_ext_file" -i "$cl_init_file" "$cl_file" -- "$@"
	else
	    exec $rlwrap "$CIM_HOME/bin/clisp" -norc --quiet --silent -on-error exit -i "$cim_ext_file" -i "$cl_init_file" "$lib_repl" -- "$@"
	fi
	;;
    ecl)

	if [ -n "$cl_sexp_p" ]; then
	    exec "$CIM_HOME/bin/ecl" -norc -q -load "$cim_ext_file" -load "$cl_init_file" -eval "$cl_sexp" -eval "(quit)" -- "$@"
	elif [ -n "$cl_file" ]; then
	    exec "$CIM_HOME/bin/ecl" -norc -q -load "$cim_ext_file" -load "$cl_init_file" -shell  "$cl_file" -- "$@"
	else
	    exec $rlwrap "$CIM_HOME/bin/ecl" -norc -q -load "$cim_ext_file" -load "$cl_init_file" -shell "$lib_repl" -- "$@"
	fi
	;;
    ccl)
	if [ -n "$cl_sexp_p" ]; then
	    exec "$CIM_HOME/bin/ccl" --no-init --quiet --batch --load "$cim_ext_file" --load "$cl_init_file" --eval "$cl_sexp" --eval '(quit)' -- "$@"
	elif [ -n "$cl_file" ]; then
	    exec "$CIM_HOME/bin/ccl" --no-init --quiet --batch --load "$cim_ext_file" --load "$cl_init_file" --load "$cl_file" --eval '(quit)' -- "$@"
	else
	    exec $rlwrap "$CIM_HOME/bin/ccl"  --no-init --quiet --batch --load "$cim_ext_file" --load "$cl_init_file" --load "$lib_repl" -- "$@"
	fi
	;;
    gcl)
	if [ -n "$cl_sexp_p" ]; then
	    exec "$CIM_HOME/bin/gcl" -batch -load "$cim_ext_file" -load "$cl_init_file" -eval "$cl_sexp" -- "$@"
	elif [ -n "$cl_file" ]; then
	    exec "$CIM_HOME/bin/gcl" -load "$cim_ext_file" -load "$cl_init_file" -f "$cl_file" -- "$@"
	else
	    exec $rlwrap "$CIM_HOME/bin/gcl" -load "$cim_ext_file" -load "$cl_init_file" -f "$lib_repl" -- "$@"
	fi
	;;
    abcl)
	if [ -n "$cl_sexp_p" ]; then
	    exec "$CIM_HOME/bin/abcl" --noinform --noinit --system --load "$cim_ext_file" --load "$cl_init_file" --batch --eval "$cl_sexp" -- "$@"
	elif [ -n "$cl_file" ]; then
	    exec "$CIM_HOME/bin/abcl" --noinform --noinit --system --load "$cim_ext_file" --load "$cl_init_file" --batch --load "$cl_file" -- "$@"
	else
	    exec $rlwrap "$CIM_HOME/bin/abcl" --noinform --noinit --system --load "$cim_ext_file" --load "$cl_init_file" --batch --load "$lib_repl" -- "$@"
	fi
	;;
    alisp)
	if [ -n "$cl_sexp_p" ]; then
	    exec alisp --qq -L "$cim_ext_file" -L "$cl_init_file" -e "$cl_sexp" --kill -- "$@"
	elif [ -n "$cl_file" ]; then
	    exec alisp --qq -L "$cim_ext_file" -L "$cl_init_file" -L "$cl_file" --kill -- "$@"
	else
	    exec $rlwrap "$CIM_HOME/bin/alisp" --qq -L "$cim_ext_file" -L "$cl_init_file" -L "$lib_repl" --kill -- "$@"
	fi
	;;
    "")
	echo "\$lisp is not set. Have you loaded ~/.cim/scripts/cim ?" >&2
	exit 1
	;;
    *)
	echo "Unknown lisp implementation $lisp_impl. Exit." >&2
	exit 1
	;;
esac

