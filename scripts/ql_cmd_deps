#!/usr/bin/env cl --no-init --
;;;; -*- mode : lisp -*-
(in-package :cim)
(defvar quicklisp-path ".quicklisp-path")
;; this is intentionally a `defparameter' for testing.
;; multiple evaluation of this file, during fiveam-based testing,
;; causes a complecated error.
(defparameter setup "")
(defparameter path (or (when (probe-file (merge-pathnames quicklisp-path))
                         (with-open-file (in (merge-pathnames quicklisp-path))
                           (read-line in)))
                       (cim_home "/quicklisp/")))
(setf *argv*
      (parse-options *argv*
        (("--path") (arg)
         "Specify the quicklisp repository."
         (setf path arg)
         (with-open-file (out quicklisp-path
                              :direction :output
                              :if-exists :supersede
                              :if-does-not-exist :create)
           (write-string path out)))))

(setf path 
      (merge-pathnames
       (pathname-as-directory path)
       (pathname-as-directory (getenv "PWD"))))

(setf setup (merge-pathnames #p"setup.lisp" path))

(if (probe-file setup) 
    (load setup)
    (progn
      (load (cim_home "/lib/quicklisp.lisp"))
      (funcall (intern "INSTALL" :quicklisp-quickstart) :path path)))

(if (consp *argv*)
    (progn
      (push (pathname-as-directory (getenv "PWD")) asdf:*central-registry*)
      (ql:quickload (intern (car *argv*))))
    (format t "Quicklisp installed to ~a" path))
