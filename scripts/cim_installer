#!/bin/sh -
# This file is for execute
set -e
: ${CIM_HOME:="$HOME/.cim"};
export CIM_HOME
umask 077
mkdir -p "$CIM_HOME/archives"
mkdir -p "$CIM_HOME/tmp"
download(){
    if which curl > /dev/null ;then
	curl -L "$1"
    elif which wget > /dev/null ;then
	wget  -O - "$1"
    elif which fetch > /dev/null;then
	fetch -o - "$1"
    fi
}
download https://codeload.github.com/KeenS/CIM/tar.gz/master | gzip -cd - | tar -xf - -C "$CIM_HOME/tmp"
mv -f "$CIM_HOME/tmp/CIM-master/"* "$CIM_HOME/" &&
rm -rf "$CIM_HOME/tmp/CIM-master/"
for dir in bin config cores impls src sysets
do
    mkdir -p "$CIM_HOME/$dir"
done
for executable in cl ql cim
do
    rm -f "$CIM_HOME/bin/$executable"
    ln -s "$CIM_HOME/scripts/$executable" "$CIM_HOME/bin/cl"
    chmod u+x "$CIM_HOME/scripts/$executable"
done
if [ ! -s "$HOME/.lisprc" ];then
    sed -i "s/\$CIM_HOME/$CIM_HOME/g" "$CIM_HOME/lib/.lisprc.default"
    cp "$CIM_HOME/lib/.lisprc.default" "$HOME/.lisprc"
fi
if expr match $SHELL '*csh' > /dev/null 2>&1 ;then
    cat <<EOM
Adding to your .`basename $SHELL`rc file
'if (-r "$CIM_HOME/init.csh" ) then
   source "$CIM_HOME/init.csh"
fi'
EOM
    case $SHELL in
	*/csh)  cat >> "$HOME/.cshrc";;
	*/tcsh) cat >> "$HOME/.zshrc";;
	*/sh)  cat >> "$HOME/.profile";;
    esac  <<EOF
if (-r "$CIM_HOME/init.csh" ) then
   source "$CIM_HOME/init.csh"
fi
EOF
else
    cat <<EOM
Adding to your .`basename $SHELL`rc file
'[ -s $HOME/.cim/init.sh ] && . $HOME/.cim/init.sh'
EOM
    case $SHELL in
	*/bash) cat >> "$HOME/.bashrc";;
	*/zsh)  cat >> "$HOME/.zshrc";;
	*/sh)   cat >> "$HOME/.profile";;
    esac  <<EOF
[ -s "$HOME/.cim/init.sh" ] && . "$HOME/.cim/init.sh"
EOF
fi
